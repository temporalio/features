name: Build docker images
on: # rebuild any PRs and main branch changes
  # Not blocking CI for this (at least yet)
  pull_request:
  push:
    branches:
      - main

jobs:
  build-images:
    strategy:
      matrix:
        include:
          - buildArgs: --repo-ref master
            runTag: go-master

          # Latest release at the time this was written
          # TODO(bergundy): Find some way to automatically upgrade to "latest"
          - buildArgs: --version v1.16
            runTag: go-1.16.0

    runs-on: ubuntu-latest
    env:
      TEMPORAL_CLOUD_ADDRESS: sdk-ci.a2dd6.tmprl.cloud:7233
      TEMPORAL_CLOUD_NAMESPACE: sdk-ci.a2dd6
      REPO_URL: ${{ github.event.pull_request.head.repo.html_url }}

    steps:
      - name: Print build information
        run: 'echo head_ref: ${{ github.head_ref }}, ref: ${{ github.ref }}, os: ${{ matrix.os }}'
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: '^1.17'
      - name: Lint go docker image
        run: docker run --rm -i hadolint/hadolint < dockerfiles/go.Dockerfile

      # Download the certs to be mounted as a volume in the running container
      - name: Download certs to temporary directory
        run: |
          mkdir /tmp/temporal-certs &&
          echo "$TEMPORAL_CLIENT_CERT" > /tmp/temporal-certs/client.pem &&
          echo "$TEMPORAL_CLIENT_KEY" > /tmp/temporal-certs/client.key &&
          wc /tmp/temporal-certs/client.pem /tmp/temporal-certs/client.key
        env:
          TEMPORAL_CLIENT_CERT: ${{ secrets.TEMPORAL_CLIENT_CERT }}
          TEMPORAL_CLIENT_KEY: ${{ secrets.TEMPORAL_CLIENT_KEY }}

      - name: Build go master image
        run: go run . build-image --lang go ${{ matrix.buildArgs }}
      - name: Test with Temporalite
        run: docker run --rm -i -v /tmp/temporal-certs:/certs sdk-features:${{ matrix.runTag }}
      - name: Test with Cloud
        run: |
          docker run --rm -i -v /tmp/temporal-certs:/certs sdk-features:${{ matrix.runTag }} \
          --server $TEMPORAL_CLOUD_ADDRESS \
          --namespace $TEMPORAL_CLOUD_NAMESPACE \
          --client-cert-path /certs/client.pem \
          --client-key-path /certs/client.key
        # Only supported in non-fork runs
        if: ${{ github.event.pull_request.head.repo.full_name == '' || github.event.pull_request.head.repo.full_name == 'temporalio/sdk-features' }}

      # TODO(bergundy): create a docker push step (only run under certain conditions - like manual trigger or main
      # branch trigger)
